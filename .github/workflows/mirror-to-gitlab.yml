name: Mirror GitHub to GitLab

on:
  push:
    branches:
      - "**"
    tags:
      - "**"
  delete:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror refs to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_MIRROR_URL: https://gitlab.com/ryanmaclean/tundra.git
        run: |
          set -euo pipefail
          if [[ -z "${GITLAB_TOKEN:-}" ]]; then
            echo "Missing secret: GITLAB_TOKEN" >&2
            exit 1
          fi

          workdir="$(mktemp -d)"
          trap 'rm -rf "$workdir"' EXIT
          mirror_dir="$workdir/mirror.git"

          git clone --mirror https://github.com/ryanmaclean/tundra.git "$mirror_dir"
          AUTH_URL="https://oauth2:${GITLAB_TOKEN}@${GITLAB_MIRROR_URL#https://}"
          git -C "$mirror_dir" push --mirror "${AUTH_URL}"

      - name: Verify ref parity
        run: |
          set -euo pipefail
          git ls-remote --heads --tags https://github.com/ryanmaclean/tundra.git | sort > gh.refs
          git ls-remote --heads --tags https://gitlab.com/ryanmaclean/tundra.git | sort > gl.refs
          diff -u gh.refs gl.refs
